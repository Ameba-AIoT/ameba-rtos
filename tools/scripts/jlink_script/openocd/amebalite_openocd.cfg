# ameba.cfg
# Usage:
#   openocd  -c "set ADAPTER_TYPE jlink" -c "set ADAPTER_SPEED 2000" -f ameba.cfg
#   openocd  -c "set ADAPTER_TYPE daplink" -c "set ADAPTER_SPEED 4000" -f ameba.cfg

# -----------------------------------------------------------------
# 1. Default Parameters
# -----------------------------------------------------------------
if { [info exists ADAPTER_TYPE] == 0 } {
    set ADAPTER_TYPE "daplink"
}
if { [info exists ADAPTER_SPEED] == 0 } {
    set ADAPTER_SPEED 3000
}

if { [info exists GDB_PORT_SPECIFIED] == 1 } {
    echo "GDB port specified: 50000"
} else {
    set GDB_PORT_SPECIFIED 0
}

# Echo config for debugging
echo "Using adapter: $ADAPTER_TYPE"
echo "SWD speed: ${ADAPTER_SPEED} kHz"

# -----------------------------------------------------------------
# 2. Load Adapter Config Dynamically
# -----------------------------------------------------------------

if { $ADAPTER_TYPE eq "jlink" } {
    source [find interface/jlink.cfg]
} elseif { $ADAPTER_TYPE eq "daplink" } {
    source [find interface/cmsis-dap.cfg]
} else {
    error "Unsupported ADAPTER_TYPE: $ADAPTER_TYPE (use 'jlink' or 'daplink')"
}

transport select swd
adapter speed $ADAPTER_SPEED

# Initialize global arrays to store failure counts and timestamps per core
array set _ameba_fail_counts {}
array set _ameba_first_fail_times {}

proc ameba_examine_hook { core_name } {
    global _ameba_fail_counts
    global _ameba_first_fail_times

    # Get current system time in seconds
    set current_time [clock seconds]

    # 1. Initialization Check
    # Ensure the array entry exists for this core before accessing it
    if { ![info exists _ameba_fail_counts($core_name)] } {
        set _ameba_fail_counts($core_name) 0
        set _ameba_first_fail_times($core_name) 0
    }

    # 2. Logic Evaluation
    # Retrieve the timestamp of the first failure in the current cycle
    set last_start_time $_ameba_first_fail_times($core_name)

    # Condition A:
    # 1. Previous count is 0 (First failure).
    # 2. OR Time elapsed since the first failure > 30s (Timeout reset).
    if { $_ameba_fail_counts($core_name) == 0 || ($current_time - $last_start_time) > 30 } {
        # Reset count to 1 and update the start timestamp for this core
        set _ameba_fail_counts($core_name) 1
        set _ameba_first_fail_times($core_name) $current_time
        echo "Warning: [string toupper $core_name] examine failed! Start counting (1/3 within 30s)"
    } else {
        # Condition B: Within the 30s window, increment the failure count
        incr _ameba_fail_counts($core_name)

        # Calculate time elapsed for logging purposes
        set time_elapsed [expr {$current_time - $last_start_time}]

        # Get the current count
        set current_count $_ameba_fail_counts($core_name)

        echo "Warning: [string toupper $core_name] examine failed! (Attempt $current_count/3, ${time_elapsed}s elapsed)"
    }

    # 3. Shutdown Trigger
    if { $_ameba_fail_counts($core_name) >= 3 } {
        echo "Error: [string toupper $core_name] examine failed 3 times within 30 seconds! Shutting down OpenOCD..."
        set _ameba_fail_counts($core_name) 0
        shutdown
    }
}

# -----------------------------------------------------------------
# 3. DAP and Targets
# -----------------------------------------------------------------
set _CHIPNAME ameba

source [find target/swj-dp.tcl]

swj_newdap ameba_chip cpu -irlen 4 -ircapture 0x1 -irmask 0xf
dap create ameba_chip.dap -chain-position ameba_chip.cpu

# --- Define the KM4 (Cortex-M33) Core ---
set _KM4_TARGETNAME $_CHIPNAME.km4
target create $_KM4_TARGETNAME cortex_m -dap ameba_chip.dap -ap-num 0
if { $GDB_PORT_SPECIFIED == 0 } {
    $_KM4_TARGETNAME configure -gdb-port 58920
}
$_KM4_TARGETNAME configure -event examine-fail { ameba_examine_hook "KM4" }

# -----------------------------------------------------------------
# 4. Global Settings
# -----------------------------------------------------------------
gdb breakpoint_override hard
bindto 0.0.0.0

echo "GDB Server Init Success! ($ADAPTER_TYPE @ ${ADAPTER_SPEED}kHz)"
